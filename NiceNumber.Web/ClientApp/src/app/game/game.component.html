<p *ngIf="!difficultyLevels"><em>Загрузка...</em></p>

<div *ngIf="!game" class="text-center">
  <span>Выберите уровень сложности:</span>
  <select [(ngModel)]="difficultyLevel" style="margin: 0 10px; background: none;">
    <option *ngFor="let dl of difficultyLevels" [value]="dl.type">{{dl.label}}</option>
  </select>
  <button class="btn btn-success" (click)="start()">Начать игру</button>
</div>
<div *ngIf="difficultyLevel == 0 && game && tasks && currentTaskIndex < tasks.length" class="tutorial-overlay">
</div>
<table class='table table-striped game-table' aria-labelledby="tableLabel" *ngIf="number" style="margin-bottom: 0;">
  <tbody>
    <tr *ngIf="difficultyLevel === 0">
      <td [colSpan]="number.length + 1">
<!--        <button (click)="increaseTask()">Следующая задача</button>-->
<!--        <table>-->
<!--          <tr>-->
<!--            <td *ngFor="let level in range(currentLevel.Order)" class="level-progress done"></td>-->
<!--          </tr>-->
<!--        </table>-->
      </td>
    </tr>
    <tr>
      <td rowspan="2" style="width: 170px; vertical-align: middle;" class="text-center game-progress">
        <div>
          <span class="score">{{game.Score}}</span> очков
        </div>
        <div style="margin-top: 5px;">
          Осталось <span class="timer">{{game.TimerSeconds * 1000 | date:'mm:ss'}}</span>
        </div>
        <div style="margin-top: 5px;">
          <b>Число:</b>
        </div>
      </td>
      <td [colSpan]="number.length">
        <div style="margin: 10px auto;">
          <button *ngIf="!endGame"
                  (click)="end(true)"
                  class="btn btn-primary text-center"
                  [ngClass]="getTutorialClass('endGame')">Завершить игру</button>
          <button *ngIf="!endGame"
                  (click)="toggleHints()"
                  [ngClass]="
                    getTutorialClass('toggleHints')"
                  class="btn btn-info text-center">{{hintsEnabled ? 'Убрать кнопки-подсказки' : 'Вернуть кнопки-подсказки'}}</button>
          <button *ngIf="!endGame && hintsEnabled"
                  [disabled]="getAnyDisabled(regularityTypes)"
                  (click)="startHintMode(null, null, false)"
                  [ngClass]="getTutorialClass('hintRandom')"
                  class="btn btn-hint text-center">Подсказать</button>
          <button *ngIf="endGame" (click)="endSession()" class="btn btn-primary text-center">Завершить сеанс</button>
          <button *ngIf="endGame && !endGame.HintsIterated"
                  (click)="showNotFound()"
                  [ngClass]="getTutorialClass('showNotFound')"
                  class="btn btn-info text-center">Показать не найденные</button>
        </div>
      </td>
    </tr>
    <tr class="digits">
      <td *ngFor="let digit of number; let i = index;" class="vertical-center">
        <button (click)="toggleSelected(digit, i)"
                [disabled]="digit.disabled"
                [ngClass]="getTutorialClass('digit', 0, i) ||
                           getTutorialClass('digit', 4, i)"
                class="btn text-center {{digit.selected ? 'btn-selected' : 'btn-deselected'}}"><span class="digit">{{ digit.value }}</span></button>
      </td>
    </tr>
    <tr *ngIf="game && !endGame"><td [colSpan]="number.length + 1">
      <table id="checks">
        <tbody>
        <tr>
          <ng-container *ngFor="let regType of regularityTypes">
            <ng-container *ngIf="startGame.ExistRegularityTypeCounts[regType.type]">
              <td class="reg-type-name text-center">
                {{regType.label}}
              </td>
            </ng-container>
          </ng-container>
        </tr>
        <tr>
          <ng-container *ngFor="let regType of regularityTypes">
            <ng-container *ngIf="startGame.ExistRegularityTypeCounts[regType.type]">
              <td class="text-center">
                <button [disabled]="!regType.enabled || filterByFound(game.ProgressRegularityInfos, regType.type).length == startGame.ExistRegularityTypeCounts[regType.type]"
                        class="btn btn-info check{{regType.enabled ? '' : ' disabled'}}"
                        [ngClass]="getTutorialClass('btnCheck', 0, regType.type)"
                        (click)="check(regType.type);">Проверить</button>
              </td>
            </ng-container>
          </ng-container>
        </tr>
        <tr>
          <ng-container *ngFor="let regType of regularityTypes">
            <ng-container *ngIf="startGame.ExistRegularityTypeCounts[regType.type]">
              <td class="text-center">
                <button [disabled]="getAnyDisabled(regularityTypes) || filterByFound(game.ProgressRegularityInfos, regType.type).length == startGame.ExistRegularityTypeCounts[regType.type]"
                        style="margin-top: 5px;"
                        class="btn btn-hint text-center"
                        [ngClass]="getTutorialClass('hintRegType', 0, regType.type)"
                        (click)="startHintMode(regType.type, null, false)"
                        *ngIf="hintsEnabled">Подсказать</button>
              </td>
            </ng-container>
          </ng-container>
          </tr>
        </tbody>
      </table>
    </td></tr>
    <tr class="result-progress"
        *ngIf="!understandDescription"
        [ngClass]="getOverOverlayClass('understand')">
      <td [colSpan]="number.length + 1">
        <ul style="margin-top: 1rem;">
          <li>Нажмите на знак вопроса <i class="bi bi-question-circle"></i> в таблице, чтобы узнать, что означает число-посказка для выбранного типа закономерности.</li>
          <ng-container *ngIf="!endGame">
            <li class="digits">Нажимайте на цифры выше, чтобы выделить <button disabled="disabled" style="width: 62px;" class="btn btn-selected text-center">5</button> или убрать выделение <button disabled="disabled" style="width: 62px;" class="btn btn-deselected text-center">5</button></li>
            <li>После того, как цифры выделены, нажмите кнопку <button disabled="disabled" class="btn btn-info check">Проверить</button> нужного типа.</li>
            <li>Если вам необходима помощь, воспользуйтесь кнопкой подсказки. Подсказки — кнопки оранжевого цвета — бывают 3-х видов: полностью случайная, случайная для выбранного типа закономерности и с фиксированным числом-подсказкой <button disabled="disabled" class="btn btn-hint btn-small">?</button>
              За подсказанную закономерность очки не начисляются</li>
            <li>Если вам мешают кнопки-подсказки, нажмите <button disabled="disabled" class="btn btn-info text-center">Убрать кнопки-подсказки</button> выше. Их можно будет вернуть в любое время в течение игры.</li>
            <li>После завершения игры, по истечению времени либо нажатием кнопки <button disabled="disabled" class="btn btn-primary text-center">Завершить игру</button>, вы сможете просмотреть все ненайденные вами закономерности.</li>
            <li>Нажмите кнопку <button class="btn btn-info"
                                       [ngClass]="getTutorialClass('understand')"
                                       (click)="understand()">Понятно</button> чтобы скрыть описание.</li>
          </ng-container>
        </ul>
      </td>
    </tr>
    <tr class="result-progress number">
      <td [colSpan]="positions.length + 1" style="padding: 10px 0!important;"><b>Тип закономерности</b><br/>Число-подсказка</td>
    </tr>
    <ng-container *ngFor="let regType of filterByExists(regularityTypes); let i = index;">
      <ng-container *ngIf="startGame.ExistRegularityTypeCounts[regType.type]">
        <tr class="result-progress reg-type-summary">
          <td [colSpan]="positions.length + 1"
              (click)="rowClick(regType.type)"
              [ngClass]="getTutorialClass('row', 0, regType.type)">
            <span class="reg-tooltip-container"
                  [ngClass]="getTutorialClass('tooltip', i)"
                  *ngIf="regType.regularityNumberHint">
              <i #tooltip="matTooltip"
                 matTooltip="Число-подсказка - {{regType.regularityNumberHint}}"
                 matTooltipClass="tooltip-regularity-type"
                 (click)="toggleTooltip(tooltip, i)"
                 class="bi bi-question-circle"></i>
            </span>
            <b> {{regType.label}}</b> (найдено: {{filterByFound(game.ProgressRegularityInfos, regType.type).length}}/{{startGame.ExistRegularityTypeCounts[regType.type]}}), числа-подсказки:
            <span *ngFor="let regularity of game.ProgressRegularityInfos[regType.type]">
              <button *ngIf="!endGame && !getHintDisabled(regularity.FoundStatus) && hintsEnabled"
                      class="btn btn-hint btn-small"
                      [disabled]="getAnyDisabled(regularityTypes) ||
                                  isTutorialActiveElement('row', 0, regType.type)"
                      [ngClass]="getTutorialClass('hintRegNum', 0, regType.type)"
                      (click)="startHintMode(regType.type, regularity.RegularityNumber, true)">?</button>
              {{regularity.ReverseRegularityNumber ? '1/' + regularity.ReverseRegularityNumber : regularity.RegularityNumber}}
              <span class="{{getHintClass(regularity.FoundStatus)}}">
                  {{getHintChar(regularity.FoundStatus)}}
              </span>&nbsp;&nbsp;
            </span>
          </td>
        </tr>
        <tr class="result-progress not-found-regs"
            *ngIf="!filterByFound(game.ProgressRegularityInfos, regType.type).length">
          <td [colSpan]="positions.length + 1">&nbsp;</td>
        </tr>
        <tr *ngFor="let regularity of filterByFound(game.ProgressRegularityInfos, regType.type)"
            class="result-progress regularity{{regularity.FoundStatus == 2 ? ' hinted' : ' found'}}">
          <td class="text-center vertical-center">
            <span *ngIf="regType.regularityNumberHint">{{regularity.RegularityNumber}}</span>
          </td>
          <ng-container *ngFor="let position of positions">
            <ng-container *ngFor="let length of [getCurrentLength(regularity.Numbers, position.value)]">
              <td class="text-center"
                  *ngIf="length.value"
                  [colSpan]="length.value">
                  <span *ngIf="length.exist"
                        class="btn btn-deselected text-center">
                    <span *ngFor="let increment of range(length.value)"
                          class="found-digit">{{number[position.value + increment].value}}</span>
                  </span>
                <span *ngIf="!length.exist">&nbsp;</span>
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </ng-container>
    </ng-container>
  </tbody>
</table>
